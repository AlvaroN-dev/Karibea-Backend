# =============================================================================
# KARIBEA BACKEND - DOCKER COMPOSE DEVELOPMENT (AUDITED & OPTIMIZED)
# =============================================================================
# ðŸŽ¯ TARGET: Local Development Machine (12-16GB RAM, 4 Cores)
# 
# âš ï¸ CRITICAL FIXES APPLIED:
#   1. Replaced deploy.resources with mem_limit/cpus (Docker Compose v2)
#   2. KEPT port exposure for local development/debugging
#   3. Fixed PostgreSQL memory parameters
#   4. Optimized HikariCP pool sizes
#   5. Adjusted JVM heap sizes for development
#
# ðŸ“Š RESOURCE ALLOCATION (12GB Dev Machine):
#   - PostgreSQL:        768MB RAM, 0.5 CPU
#   - Kafka (Ã—3):        512MB each = 1.5GB total, 0.3 CPU each
#   - Config Server:     256MB RAM, 0.15 CPU
#   - Eureka:            384MB RAM, 0.2 CPU
#   - Gateway:           384MB RAM, 0.3 CPU
#   - Microservices (Ã—14): 320MB each = ~4.5GB total
#   - System Reserve:    ~3GB (for IDE, browser, etc.)
#   - TOTAL ALLOCATED:   ~8GB (67% of 12GB)
# =============================================================================

services:
  # ===========================================================================
  # INFRASTRUCTURE SERVICES
  # ===========================================================================
  
  postgres:
    image: postgres:15-alpine
    container_name: karibea-postgres
    environment:
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    command: 
      - "postgres"
      # Development-friendly settings
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=384MB"
      - "-c"
      - "maintenance_work_mem=32MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=8MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=2MB"
      - "-c"
      - "min_wal_size=256MB"
      - "-c"
      - "max_wal_size=1GB"
      # Development logging
      - "-c"
      - "log_statement=all"
      - "-c"
      - "log_duration=on"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - karibea-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME}"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    mem_limit: 768m
    mem_reservation: 256m
    cpus: 0.5

  # ---------------------------------------------------------------------------
  # KAFKA CLUSTER (3 Brokers - KRaft Mode) - Development
  # ---------------------------------------------------------------------------
  
  kafka-0:
    image: apache/kafka:4.0.1
    container_name: karibea-kafka-0
    environment:
      CLUSTER_ID: ${KAFKA_CLUSTER_ID}
      KAFKA_NODE_ID: ${KAFKA_NODE_ID_0}
      KAFKA_PROCESS_ROLES: ${KAFKA_PROCESS_ROLES}
      KAFKA_CONTROLLER_QUORUM_VOTERS: ${KAFKA_CONTROLLER_QUORUM_VOTERS}
      KAFKA_LISTENERS: ${KAFKA_LISTENERS_0}
      KAFKA_ADVERTISED_LISTENERS: ${KAFKA_ADVERTISED_LISTENERS_0}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: ${KAFKA_LISTENER_SECURITY_PROTOCOL_MAP}
      KAFKA_CONTROLLER_LISTENER_NAMES: ${KAFKA_CONTROLLER_LISTENER_NAMES}
      KAFKA_INTER_BROKER_LISTENER_NAME: ${KAFKA_INTER_BROKER_LISTENER_NAME}
      KAFKA_HEAP_OPTS: "-Xms192m -Xmx384m"
      KAFKA_LOG_DIRS: ${KAFKA_LOG_DIRS}
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: ${KAFKA_AUTO_CREATE_TOPICS_ENABLE}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: ${KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR}
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: ${KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR}
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: ${KAFKA_TRANSACTION_STATE_LOG_MIN_ISR}
    ports:
      - "9094:9094"
    volumes:
      - kafka_0_data:/var/lib/kafka/data
    networks:
      - karibea-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    mem_limit: 512m
    mem_reservation: 256m
    cpus: 0.3

  kafka-1:
    image: apache/kafka:4.0.1
    container_name: karibea-kafka-1
    environment:
      CLUSTER_ID: ${KAFKA_CLUSTER_ID}
      KAFKA_NODE_ID: ${KAFKA_NODE_ID_1}
      KAFKA_PROCESS_ROLES: ${KAFKA_PROCESS_ROLES}
      KAFKA_CONTROLLER_QUORUM_VOTERS: ${KAFKA_CONTROLLER_QUORUM_VOTERS}
      KAFKA_LISTENERS: ${KAFKA_LISTENERS_1}
      KAFKA_ADVERTISED_LISTENERS: ${KAFKA_ADVERTISED_LISTENERS_1}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: ${KAFKA_LISTENER_SECURITY_PROTOCOL_MAP}
      KAFKA_CONTROLLER_LISTENER_NAMES: ${KAFKA_CONTROLLER_LISTENER_NAMES}
      KAFKA_INTER_BROKER_LISTENER_NAME: ${KAFKA_INTER_BROKER_LISTENER_NAME}
      KAFKA_HEAP_OPTS: "-Xms192m -Xmx384m"
      KAFKA_LOG_DIRS: ${KAFKA_LOG_DIRS}
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: ${KAFKA_AUTO_CREATE_TOPICS_ENABLE}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: ${KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR}
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: ${KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR}
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: ${KAFKA_TRANSACTION_STATE_LOG_MIN_ISR}
    ports:
      - "9095:9095"
    volumes:
      - kafka_1_data:/var/lib/kafka/data
    networks:
      - karibea-network
    depends_on:
      kafka-0:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    mem_limit: 512m
    mem_reservation: 256m
    cpus: 0.3

  kafka-2:
    image: apache/kafka:4.0.1
    container_name: karibea-kafka-2
    environment:
      CLUSTER_ID: ${KAFKA_CLUSTER_ID}
      KAFKA_NODE_ID: ${KAFKA_NODE_ID_2}
      KAFKA_PROCESS_ROLES: ${KAFKA_PROCESS_ROLES}
      KAFKA_CONTROLLER_QUORUM_VOTERS: ${KAFKA_CONTROLLER_QUORUM_VOTERS}
      KAFKA_LISTENERS: ${KAFKA_LISTENERS_2}
      KAFKA_ADVERTISED_LISTENERS: ${KAFKA_ADVERTISED_LISTENERS_2}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: ${KAFKA_LISTENER_SECURITY_PROTOCOL_MAP}
      KAFKA_CONTROLLER_LISTENER_NAMES: ${KAFKA_CONTROLLER_LISTENER_NAMES}
      KAFKA_INTER_BROKER_LISTENER_NAME: ${KAFKA_INTER_BROKER_LISTENER_NAME}
      KAFKA_HEAP_OPTS: "-Xms192m -Xmx384m"
      KAFKA_LOG_DIRS: ${KAFKA_LOG_DIRS}
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: ${KAFKA_AUTO_CREATE_TOPICS_ENABLE}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: ${KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR}
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: ${KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR}
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: ${KAFKA_TRANSACTION_STATE_LOG_MIN_ISR}
    ports:
      - "9096:9096"
    volumes:
      - kafka_2_data:/var/lib/kafka/data
    networks:
      - karibea-network
    depends_on:
      kafka-0:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    mem_limit: 512m
    mem_reservation: 256m
    cpus: 0.3

  kafka-init:
    image: apache/kafka:4.0.1
    container_name: karibea-kafka-init
    depends_on:
      kafka-0:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
      kafka-2:
        condition: service_healthy
    command: >
      bash -c "
        echo 'Creating Kafka topics...' &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic orders &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic order-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic payments &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic payment-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic inventory &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic inventory-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic notifications &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic notification-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic shipping &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic shipping-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic products &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic product-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic user-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic marketing-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic review-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic search-events &&
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka-0:9092 --replication-factor 1 --partitions 3 --topic cart-events &&
        echo 'All topics created successfully!'
      "
    networks:
      - karibea-network
    restart: "no"

  # ===========================================================================
  # CORE SERVICES
  # ===========================================================================
  
  microservice-config:
    build:
      context: ./microservice-config
      dockerfile: Dockerfile
    container_name: karibea-config
    ports:
      - "8888:8888"
    environment:
      SERVER_PORT: 8888
      SPRING_PROFILES_ACTIVE: native
      SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS: classpath:/config/
      EUREKA_CLIENT_ENABLED: "false"
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx192m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8888/actuator/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 45s
    restart: unless-stopped
    mem_limit: 256m
    mem_reservation: 128m
    cpus: 0.15

  microservice-eureka:
    build:
      context: ./microservice-eureka
      dockerfile: Dockerfile
    container_name: karibea-eureka
    ports:
      - "8761:8761"
    environment:
      SERVER_PORT: 8761
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_REGISTER_WITH_EUREKA: "false"
      EUREKA_CLIENT_FETCH_REGISTRY: "false"
      EUREKA_SERVER_ENABLE_SELF_PRESERVATION: "false"
      EUREKA_SERVER_EVICTION_INTERVAL_TIMER_IN_MS: 5000
      JAVA_TOOL_OPTIONS: "-Xms192m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8761/actuator/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    mem_limit: 384m
    mem_reservation: 192m
    cpus: 0.2

  microservice-gateway:
    build:
      context: ./microservice-gateway
      dockerfile: Dockerfile
    container_name: karibea-gateway
    ports:
      - "8080:8080"
    environment:
      SERVER_PORT: 8080
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: ${JWT_ISSUER_URI}
      JAVA_TOOL_OPTIONS: "-Xms192m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    mem_limit: 384m
    mem_reservation: 192m
    cpus: 0.3

  # ===========================================================================
  # BUSINESS MICROSERVICES (Development - Ports Exposed for Debugging)
  # ===========================================================================

  microservice-catalog:
    build:
      context: ./microservice-catalog
      dockerfile: Dockerfile
    container_name: karibea-catalog
    ports:
      - "8081:8081"
    environment:
      SERVER_PORT: 8081
      SPRING_APPLICATION_NAME: microservice-catalog
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_catalog
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-identity:
    build:
      context: ./microservice-identity
      dockerfile: Dockerfile
    container_name: karibea-identity
    ports:
      - "8082:8082"
    environment:
      SERVER_PORT: 8082
      SPRING_APPLICATION_NAME: microservice-identity
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_identity
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms192m -Xmx320m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 384m
    mem_reservation: 256m
    cpus: 0.25

  microservice-user:
    build:
      context: ./microservice-user
      dockerfile: Dockerfile
    container_name: karibea-user
    ports:
      - "8083:8083"
    environment:
      SERVER_PORT: 8083
      SPRING_APPLICATION_NAME: microservice-user
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_user
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-order:
    build:
      context: ./microservice-order
      dockerfile: Dockerfile
    container_name: karibea-order
    ports:
      - "8084:8084"
    environment:
      SERVER_PORT: 8084
      SPRING_APPLICATION_NAME: microservice-order
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_order
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-payment:
    build:
      context: ./microservice-payment
      dockerfile: Dockerfile
    container_name: karibea-payment
    ports:
      - "8085:8085"
    environment:
      SERVER_PORT: 8085
      SPRING_APPLICATION_NAME: microservice-payment
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_payment
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      STRIPE_API_KEY: ${STRIPE_API_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      PAYPAL_CLIENT_ID: ${PAYPAL_CLIENT_ID}
      PAYPAL_CLIENT_SECRET: ${PAYPAL_CLIENT_SECRET}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-inventory:
    build:
      context: ./microservice-inventory
      dockerfile: Dockerfile
    container_name: karibea-inventory
    ports:
      - "8086:8086"
    environment:
      SERVER_PORT: 8086
      SPRING_APPLICATION_NAME: microservice-inventory
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_inventory
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-shopcart:
    build:
      context: ./microservice-shopcart
      dockerfile: Dockerfile
    container_name: karibea-shopcart
    ports:
      - "8087:8087"
    environment:
      SERVER_PORT: 8087
      SPRING_APPLICATION_NAME: microservice-shopcart
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_shopcart
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-shipping:
    build:
      context: ./microservice-shipping
      dockerfile: Dockerfile
    container_name: karibea-shipping
    ports:
      - "8088:8088"
    environment:
      SERVER_PORT: 8088
      SPRING_APPLICATION_NAME: microservice-shipping
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_shipping
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-notification:
    build:
      context: ./microservice-notification
      dockerfile: Dockerfile
    container_name: karibea-notification
    ports:
      - "8089:8089"
    environment:
      SERVER_PORT: 8089
      SPRING_APPLICATION_NAME: microservice-notification
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_notification
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_MAIL_HOST: ${MAIL_HOST}
      SPRING_MAIL_PORT: ${MAIL_PORT}
      SPRING_MAIL_USERNAME: ${MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8089/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-marketing:
    build:
      context: ./microservice-marketing
      dockerfile: Dockerfile
    container_name: karibea-marketing
    ports:
      - "8090:8090"
    environment:
      SERVER_PORT: 8090
      SPRING_APPLICATION_NAME: microservice-marketing
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_marketing
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-review:
    build:
      context: ./microservice-review
      dockerfile: Dockerfile
    container_name: karibea-review
    ports:
      - "8091:8091"
    environment:
      SERVER_PORT: 8091
      SPRING_APPLICATION_NAME: microservice-review
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_review
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8091/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-search:
    build:
      context: ./microservice-search
      dockerfile: Dockerfile
    container_name: karibea-search
    ports:
      - "8092:8092"
    environment:
      SERVER_PORT: 8092
      SPRING_APPLICATION_NAME: microservice-search
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_search
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_ELASTICSEARCH_URIS: ${ELASTICSEARCH_URIS}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8092/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-store:
    build:
      context: ./microservice-store
      dockerfile: Dockerfile
    container_name: karibea-store
    ports:
      - "8093:8093"
    environment:
      SERVER_PORT: 8093
      SPRING_APPLICATION_NAME: microservice-store
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_store
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8093/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

  microservice-chatbot:
    build:
      context: ./microservice-chatbot
      dockerfile: Dockerfile
    container_name: karibea-chatbot
    ports:
      - "8094:8094"
    environment:
      SERVER_PORT: 8094
      SPRING_APPLICATION_NAME: microservice-chatbot
      SPRING_CONFIG_IMPORT: optional:configserver:http://microservice-config:8888
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://microservice-eureka:8761/eureka/
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka-0:9092,kafka-1:9092,kafka-2:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/karibea_chatbot
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL}
      CHATBOT_AI21_API_KEY: ${CHATBOT_AI21_API_KEY}
      CHATBOT_AI21_API_URL: ${CHATBOT_AI21_API_URL}
      CHATBOT_AI21_MODEL: ${CHATBOT_AI21_MODEL}
      CHATBOT_AI21_MAX_TOKENS: ${CHATBOT_AI21_MAX_TOKENS}
      CHATBOT_AI21_TEMPERATURE: ${CHATBOT_AI21_TEMPERATURE}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 2
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: 1
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom"
    networks:
      - karibea-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka-0:
        condition: service_healthy
      microservice-eureka:
        condition: service_healthy
      microservice-config:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8094/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped
    mem_limit: 320m
    mem_reservation: 192m
    cpus: 0.2

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  karibea-network:
    driver: bridge
    name: karibea-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  postgres_data:
    name: karibea-postgres-data
  kafka_0_data:
    name: karibea-kafka-0-data
  kafka_1_data:
    name: karibea-kafka-1-data
  kafka_2_data:
    name: karibea-kafka-2-data
